#!/bin/sh
########################## SAI Technology ##############################
########### Script to install Active directory and phpldapamin##########
##apt-get install -y apache2

password='radius123'
dn='dc=saitechnology,dc=com'
ldap_ip=127.0.0.1
########## Debean configuration setup###################################
cat << EOF | sudo debconf-set-selections
slapd slapd/internal/adminpw password radius123
slapd slapd/internal/generated_adminpw password radius123
slapd slapd/password2 password radius123
slapd slapd/password1 password radius123
slapd slapd/dump_database_destdir string /var/backups/slapd-VERSION
slapd slapd/domain string saitechnology.com
slapd shared/organization string SAITECHNOLOGY
slapd slapd/backend string HDB
slapd slapd/purge_database boolean true
slapd slapd/move_old_database boolean true
slapd slapd/allow_ldap_v2 boolean false
slapd slapd/no_configuration boolean false
slapd slapd/dump_database string when needed
EOF
##################### Installl slapd and ldap-utils###############
apt-get install -y slapd ldap-utils 

hash_pw=`slappasswd -s $password`
##################### update base file ldap.conf #################
cat << EOF > /etc/ldap/ldap.conf
BASE    $dn
URI     ldap://$ldap_ip
SSL     no
pam_password    md5
TLS_CACERT      /etc/ssl/certs/ca-certificates.crt
nss_initgroups_ignoreusers root,ldap,named,avahi,haldaemon,dbus,radvd,tomcat,radiusd,news,mailman,nscd,gdm
EOF
######## Reconfigure database in noninteractive mode (with pre-configured setup##
dpkg-reconfigure -f noninteractive slapd

ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/ldap/schema/core.ldif
ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/ldap/schema/cosine.ldif 
ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/ldap/schema/inetorgperson.ldif 
ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/ldap/schema/nis.ldif 

cat << EOF > database.ldif
dn: olcDatabase={1}hdb,cn=config
changetype: modify
replace: olcRootPW
olcRootPW: $hash_pw

dn: olcDatabase={1}hdb,cn=config
add: olcAccess
olcAccess: {0}to attrs=userPassword,shadowLastChange by dn="cn=admin,$dn" write by anonymous auth by self write by * none
olcAccess: {1}to dn.subtree="" by * read
olcAccess: {2}to * by dn="cn=admin,$dn" write by * read

dn: olcDatabase={1}hdb,cn=config
add: olcDbIndex
olcDbIndex: uid,gidNumber,uidNumber pres,eq
olcDbIndex: cn,sn,mail,givenName,memberUid pres,eq,approx,sub

dn: olcDatabase={-1}frontend,cn=config
changetype: modify
delete: olcAccess

dn: olcDatabase={0}config,cn=config
changetype: modify
add: olcRootDN
olcRootDN: cn=admin,cn=config

dn: olcDatabase={0}config,cn=config
changetype: modify
add: olcRootPW
olcRootPW: $hash_pw
EOF

#####  use database.ldif (newly created file) to add to database ######
ldapmodify -Y EXTERNAL -H ldapi:/// -f database.ldif
########### Installl phpldapadmin #####################################
apt-get install -y phpldapadmin
cp -f config.php /etc/phpldapadmin/
cp -f phpldapadmin.conf /etc/apache2/conf-enabled/
rm -rf /usr/share/phpldapadmin
cp -f phpldapadmin/ /usr/share/
service apache2 restart
